<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãŠé¢¨å‘‚ æ··é›‘äºˆæ¸¬ï¼†äºˆç´„ï¼ˆURLè‡ªå‹•å…±æœ‰ï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#f2f6f8;
  margin:0;
  padding:12px;
}
.container{
  max-width:420px;
  margin:auto;
  background:#fff;
  border-radius:16px;
  padding:16px;
}
h1{text-align:center;font-size:1.3rem;}
.time{text-align:center;color:#555;margin-bottom:8px;}
.status{
  text-align:center;
  padding:18px;
  border-radius:12px;
  font-size:1.2rem;
  font-weight:bold;
  margin-bottom:14px;
}
.empty{background:#d4f8d4;color:#2e7d32;}
.crowded{background:#f8d7da;color:#721c24;}

input[type="time"]{
  width:100%;
  font-size:1.1rem;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
  text-align:center;
  margin-bottom:8px;
}

button{
  width:100%;
  height:52px;
  font-size:1.1rem;
  border-radius:12px;
  border:none;
  color:#fff;
  margin-top:8px;
}
.reserveBtn{background:#2196f3;}
.resetBtn{background:#f44336;}
.copyBtn{background:#4caf50;}

#reserveResult{
  margin-top:10px;
  padding:10px;
  border-radius:8px;
  font-weight:bold;
  text-align:center;
}
.msg-success{background:#d4f8d4;color:#2e7d32;}
.msg-error{background:#f8d7da;color:#721c24;}

.chart-scroll{overflow-x:auto;}
.chart-scroll canvas{
  min-width:360px;
  max-width:900px;
  height:260px !important;
}
</style>
</head>

<body>
<div class="container">
<h1>ğŸ› ãŠé¢¨å‘‚ æ··é›‘äºˆæ¸¬ï¼†äºˆç´„</h1>

<div class="time" id="currentTime"></div>
<div class="status" id="statusBox">åˆ¤å®šä¸­â€¦</div>

<h2>åˆ©ç”¨äºˆç´„ï¼ˆURLè‡ªå‹•å…±æœ‰ï¼‰</h2>

<input type="time" id="reserveTime">
<button class="reserveBtn" onclick="reserve()">äºˆç´„ã™ã‚‹</button>
<button class="resetBtn" onclick="resetReservations()">äºˆç´„ã‚’1äººå‰Šé™¤</button>
<button class="copyBtn" onclick="copyURL()">URLã‚’ã‚³ãƒ”ãƒ¼</button>

<div id="reserveResult"></div>

<h2 style="margin-top:16px;">äºˆç´„çŠ¶æ³</h2>
<div class="chart-scroll">
  <canvas id="reservationChart"></canvas>
</div>
</div>

<script>
/* ===== åŸºæœ¬è¨­å®š ===== */
const maxCapacity = 10;
const start = 15*60+30;
const end   = 20*60+20;

/* ===== æ™‚åˆ»ãƒ©ãƒ™ãƒ« ===== */
const timeLabels=[];
for(let m=start;m<=end;m+=10){
  timeLabels.push(
    String(Math.floor(m/60)).padStart(2,"0")+":"+String(m%60).padStart(2,"0")
  );
}

/* ===== URLå…±æœ‰ç”¨ ===== */
function encodeData(obj){
  return btoa(encodeURIComponent(JSON.stringify(obj)));
}
function decodeData(str){
  return JSON.parse(decodeURIComponent(atob(str)));
}

/* ===== äºˆç´„ãƒ‡ãƒ¼ã‚¿ ===== */
let sharedReservations = {};

/* èµ·å‹•æ™‚ï¼šURLã‹ã‚‰å¾©å…ƒ */
(function loadFromURL(){
  const p = new URLSearchParams(location.search);
  if(p.has("data")){
    try{
      sharedReservations = decodeData(p.get("data"));
    }catch{
      sharedReservations = {};
    }
  }
})();

function loadReservations(){
  return sharedReservations;
}
function saveReservations(d){
  sharedReservations = d;
}

/* ===== URLè‡ªå‹•æ›´æ–° ===== */
function updateURL(){
  const data = encodeData(loadReservations());
  const newURL =
    location.origin +
    location.pathname +
    "?data=" + data;
  history.replaceState(null, "", newURL);
}

/* ===== æ™‚åˆ»è¡¨ç¤º ===== */
function updateTime(){
  const n=new Date();
  document.getElementById("currentTime").textContent=
    `ç¾åœ¨æ™‚åˆ»ï¼š${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}`;
}

/* ===== ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ ===== */
function predictCrowd(){
  const n=new Date();
  const m=n.getHours()*60+n.getMinutes();
  const s=document.getElementById("statusBox");
  s.className="status";
  if(m<start||m>end){
    s.textContent="ğŸš« åˆ©ç”¨æ™‚é–“å¤–";
    s.classList.add("crowded");
  }else{
    s.textContent="ğŸŸ¢ åˆ©ç”¨å¯èƒ½";
    s.classList.add("empty");
  }
}

/* ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===== */
function showMessage(msg,type="success"){
  const e=document.getElementById("reserveResult");
  e.textContent=msg;
  e.className=type==="success"?"msg-success":"msg-error";
}

/* ===== äºˆç´„å‡¦ç† ===== */
function reserve(){
  const t=document.getElementById("reserveTime").value;
  if(!t){
    showMessage("æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„","error");
    return;
  }

  const [h,m]=t.split(":").map(Number);
  const min=h*60+m;
  const now=new Date();
  const nowMin=now.getHours()*60+now.getMinutes();

  if(min<start||min>end||min<nowMin){
    showMessage("ã“ã®æ™‚é–“ã¯äºˆç´„ã§ãã¾ã›ã‚“","error");
    return;
  }

  const r=loadReservations();
  if((r[t]||0)>=maxCapacity){
    showMessage(`${t} ã¯æº€å“¡ã§ã™`,"error");
    return;
  }

  r[t]=(r[t]||0)+1;
  saveReservations(r);
  updateURL();                // â˜… è‡ªå‹•URLæ›´æ–°
  showMessage(`${t} ã«äºˆç´„ã—ã¾ã—ãŸï¼ˆ${r[t]}äººç›®ï¼‰`);
  drawReservationChart();
}

function resetReservations(){
  const t=document.getElementById("reserveTime").value;
  if(!t){
    showMessage("æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„","error");
    return;
  }

  const r=loadReservations();
  if(!r[t]){
    showMessage("ãã®æ™‚é–“ã«äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“","error");
    return;
  }

  r[t]--;
  if(r[t]<=0) delete r[t];
  saveReservations(r);
  updateURL();                // â˜… è‡ªå‹•URLæ›´æ–°
  showMessage("1äººå‰Šé™¤ã—ã¾ã—ãŸ");
  drawReservationChart();
}

/* ===== URLã‚³ãƒ”ãƒ¼ ===== */
function copyURL(){
  navigator.clipboard.writeText(location.href);
  showMessage("ç¾åœ¨ã®URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");
}

/* ===== äºˆç´„ã‚°ãƒ©ãƒ• ===== */
let reservationChart;
const reservationChartCanvas=document.getElementById("reservationChart");

function drawReservationChart(){
  const data=timeLabels.map(t=>loadReservations()[t]||0);
  if(reservationChart) reservationChart.destroy();
  reservationChart=new Chart(reservationChartCanvas,{
    type:"bar",
    data:{
      labels:timeLabels,
      datasets:[{
        data,
        backgroundColor:data.map(v=>v>=maxCapacity?"#f44336":"#ff9800")
      }]
    },
    options:{
      indexAxis:"y",
      responsive:true,
      maintainAspectRatio:false,
      scales:{x:{min:0,max:maxCapacity}},
      plugins:{legend:{display:false}}
    }
  });
}

/* ===== åˆæœŸåŒ– ===== */
updateTime();
predictCrowd();
drawReservationChart();
setInterval(()=>{updateTime();predictCrowd();},10000);
</script>
</body>
</html>
