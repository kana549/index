<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãŠé¢¨å‘‚ æ··é›‘äºˆæ¸¬ï¼†äºˆç´„</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: #f2f6f8;
  margin: 0;
  padding: 12px;
}

.container {
  max-width: 420px;
  margin: auto;
  background: #fff;
  border-radius: 16px;
  padding: 16px;
}

h1 {
  text-align: center;
  font-size: 1.3rem;
}

.time {
  text-align: center;
  color: #555;
  margin-bottom: 10px;
}

.status {
  text-align: center;
  padding: 20px;
  border-radius: 12px;
  font-size: 1.3rem;
  font-weight: bold;
  margin-bottom: 16px;
}

.empty {
  background: #d4f8d4;
  color: #2e7d32;
}

.crowded {
  background: #f8d7da;
  color: #721c24;
}

input[type="time"] {
  width: 100%;
  font-size: 1.2rem;
  padding: 12px;
  border-radius: 10px;
  border: 1px solid #ccc;
  text-align: center;
}

.reservation button {
  width: 100%;
  height: 52px;
  font-size: 1.1rem;
  border-radius: 12px;
  border: none;
  color: #fff;
  margin-top: 10px;
}

.reserveBtn {
  background: #2196f3;
}

.resetBtn {
  background: #f44336;
}

button:disabled {
  opacity: 0.4;
}

#reserveResult {
  margin-top: 10px;
  padding: 10px;
  border-radius: 8px;
  font-weight: bold;
  text-align: center;
}

.msg-success {
  background: #d4f8d4;
  color: #2e7d32;
}

.msg-error {
  background: #f8d7da;
  color: #721c24;
}

.chart-scroll {
  overflow-x: auto;
}

.chart-scroll canvas {
  min-width: 600px;
}
</style>
</head>

<body>
<div class="container">
  <h1>ğŸ› ãŠé¢¨å‘‚ æ··é›‘äºˆæ¸¬ï¼†äºˆç´„</h1>

  <div class="time" id="currentTime"></div>
  <div class="status" id="statusBox">åˆ¤å®šä¸­â€¦</div>

  <div class="chart-scroll">
    <canvas id="crowdChart"></canvas>
  </div>

  <div class="reservation">
    <h2>åˆ©ç”¨äºˆç´„</h2>

    <input type="time" id="reserveTime" list="timeList">
    <datalist id="timeList"></datalist>

    <button id="reserveBtn" class="reserveBtn" onclick="reserve()">äºˆç´„ã™ã‚‹</button>
    <button class="resetBtn" onclick="resetReservations()">äºˆç´„ã‚’1äººå‰Šé™¤</button>

    <div id="reserveResult"></div>

    <h2 style="margin-top:20px;">äºˆç´„çŠ¶æ³</h2>
    <div class="chart-scroll">
      <canvas id="reservationChart"></canvas>
    </div>
  </div>
</div>

<script>
/* ===== åŸºæœ¬è¨­å®š ===== */
const maxCapacity = 10;
const start = 15 * 60 + 30;
const end   = 20 * 60 + 20;

/* ===== 10åˆ†åˆ»ã¿ç”Ÿæˆ ===== */
const reserveLabels = [];
for(let m=start; m<=end; m+=10){
  const h = String(Math.floor(m/60)).padStart(2,"0");
  const mm = String(m%60).padStart(2,"0");
  reserveLabels.push(`${h}:${mm}`);
}

/* datalist */
const dl = document.getElementById("timeList");
reserveLabels.forEach(t=>{
  const o=document.createElement("option");
  o.value=t;
  dl.appendChild(o);
});

/* æ™‚åˆ»è¡¨ç¤º */
function updateTime(){
  const n=new Date();
  document.getElementById("currentTime").textContent =
    `ç¾åœ¨æ™‚åˆ»ï¼š${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}`;
}

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
function showMessage(msg,type="success"){
  const e=document.getElementById("reserveResult");
  e.textContent=msg;
  e.className=type==="success"?"msg-success":"msg-error";
}

/* äºˆç´„å¯èƒ½åˆ¤å®š */
function isReservableTime(t){
  if(!reserveLabels.includes(t)) return false;
  const [h,m]=t.split(":").map(Number);
  const sel=h*60+m;
  const now=new Date();
  const nowMin=now.getHours()*60+now.getMinutes();
  return sel>=start && sel<=end && sel>=nowMin;
}

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ */
function predictCrowd(){
  const n=new Date();
  const m=n.getHours()*60+n.getMinutes();
  const s=document.getElementById("statusBox");
  s.className="status";

  if(m<start||m>end){
    s.innerHTML="ğŸš« åˆ©ç”¨æ™‚é–“å¤–";
    s.classList.add("crowded");
  }else{
    s.innerHTML="ğŸŸ¢ åˆ©ç”¨å¯èƒ½";
    s.classList.add("empty");
  }
}

/* äºˆç´„ä¿å­˜ */
function loadReservations(){
  return JSON.parse(localStorage.getItem("bathReservations"))||{};
}
function saveReservations(d){
  localStorage.setItem("bathReservations",JSON.stringify(d));
}

let reservationChart;

function reserve(){
  if(navigator.vibrate) navigator.vibrate(20);

  const t=document.getElementById("reserveTime").value;
  if(!isReservableTime(t)){
    showMessage("ã“ã®æ™‚é–“ã¯äºˆç´„ã§ãã¾ã›ã‚“","error");
    return;
  }

  const r=loadReservations();
  if((r[t]||0)>=maxCapacity){
    showMessage("æº€å“¡ã§ã™","error");
    return;
  }

  r[t]=(r[t]||0)+1;
  saveReservations(r);
  showMessage(`${t} ã«äºˆç´„ã—ã¾ã—ãŸ`);
  drawReservationChart();
}

function resetReservations(){
  const t=document.getElementById("reserveTime").value;
  const r=loadReservations();
  if(!r[t]){
    showMessage("äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“","error");
    return;
  }
  r[t]--;
  if(r[t]<=0) delete r[t];
  saveReservations(r);
  showMessage("1äººå‰Šé™¤ã—ã¾ã—ãŸ");
  drawReservationChart();
}

function drawReservationChart(){
  const data=reserveLabels.map(t=>loadReservations()[t]||0);
  if(reservationChart) reservationChart.destroy();
  reservationChart=new Chart(document.getElementById("reservationChart"),{
    type:"bar",
    data:{labels:reserveLabels,datasets:[{data}]},
    options:{scales:{y:{min:0,max:maxCapacity}}}
  });
}

/* ãƒœã‚¿ãƒ³åˆ¶å¾¡ */
function updateReserveButton(){
  const n=new Date();
  const m=n.getHours()*60+n.getMinutes();
  const b=document.getElementById("reserveBtn");
  b.disabled = (m<start||m>end);
}

/* åˆæœŸåŒ– */
updateTime();
predictCrowd();
drawReservationChart();
updateReserveButton();

setInterval(()=>{
  updateTime();
  predictCrowd();
  updateReserveButton();
},10000);
</script>
</body>
</html>
