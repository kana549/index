<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãŠé¢¨å‘‚ æ··é›‘äºˆæ¸¬ï¼†äºˆç´„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: sans-serif;
      background: #f2f6f8;
      margin: 0;
      padding: 20px;
    }
    .container {
      max-width: 420px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    h1 { text-align: center; font-size: 1.4rem; }
    .time { text-align: center; color: #555; margin-bottom: 10px; }
    .status {
      text-align: center;
      padding: 18px;
      border-radius: 10px;
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 15px;
    }
    .empty { background: #d4f8d4; color: #2e7d32; }
    .crowded { background: #f8d7da; color: #721c24; }

    .reservation button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 8px;
    }
    .reserveBtn { background: #2196f3; }
    .resetBtn { background: #f44336; }

    #reserveResult {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
    }
    .msg-success { background: #d4f8d4; color: #2e7d32; }
    .msg-error { background: #f8d7da; color: #721c24; }
  </style>
</head>

<body>
<div class="container">
  <h1>ğŸ› ãŠé¢¨å‘‚ æ··é›‘äºˆæ¸¬ï¼†äºˆç´„</h1>
  <div class="time" id="currentTime"></div>
  <div class="status" id="statusBox">äºˆæ¸¬ä¸­â€¦</div>

  <canvas id="crowdChart"></canvas>

  <div class="reservation">
    <h2>åˆ©ç”¨äºˆç´„</h2>

    <input type="time" id="reserveTime" list="timeList">
    <datalist id="timeList"></datalist>

    <button id="reserveBtn" class="reserveBtn" onclick="reserve()">äºˆç´„ã™ã‚‹</button>
    <button class="resetBtn" onclick="resetReservations()">äºˆç´„ã‚’1äººå‰Šé™¤</button>
    <div id="reserveResult"></div>

    <h2 style="margin-top:20px;">ç¾åœ¨ã®äºˆç´„çŠ¶æ³</h2>
    <canvas id="reservationChart"></canvas>
  </div>
</div>

<script>
/* ===== åŸºæœ¬è¨­å®š ===== */
const maxCapacity = 10;
const start = 15 * 60 + 30;
const end   = 20 * 60 + 20;

/* ===== 10åˆ†åˆ»ã¿æ™‚åˆ»ç”Ÿæˆ ===== */
const reserveLabels = [];
for(let m = start; m <= end; m += 10){
  const h = Math.floor(m / 60).toString().padStart(2,"0");
  const mm = (m % 60).toString().padStart(2,"0");
  reserveLabels.push(`${h}:${mm}`);
}

/* datalist ã«åæ˜  */
const dl = document.getElementById("timeList");
reserveLabels.forEach(t=>{
  const o = document.createElement("option");
  o.value = t;
  dl.appendChild(o);
});

/* ===== æ™‚åˆ»è¡¨ç¤º ===== */
function updateTime(){
  const n = new Date();
  document.getElementById("currentTime").textContent =
    `ç¾åœ¨æ™‚åˆ»ï¼š${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`;
}

/* ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===== */
function showMessage(msg,type="success"){
  const e = document.getElementById("reserveResult");
  e.textContent = msg;
  e.className = type === "success" ? "msg-success" : "msg-error";
}

/* ===== åˆ©ç”¨å¯å¦åˆ¤å®š ===== */
function isReservableTime(t){
  if(!reserveLabels.includes(t)) return false;

  const [h,m] = t.split(":").map(Number);
  const sel = h*60+m;

  const now = new Date();
  const nowMin = now.getHours()*60 + now.getMinutes();

  if(sel < start || sel > end) return false;
  if(sel < nowMin) return false; // éå»ä¸å¯

  return true;
}

/* ===== æ··é›‘è¡¨ç¤º ===== */
function predictCrowd(){
  const n = new Date();
  const m = n.getHours()*60+n.getMinutes();
  const s = document.getElementById("statusBox");
  s.className="status";

  if(m < start || m > end){
    s.textContent="ç©ºã„ã¦ã„ã¾ã›ã‚“";
    s.classList.add("crowded");
    return;
  }
  s.textContent="åˆ©ç”¨å¯èƒ½";
  s.classList.add("empty");
}

/* ===== äºˆç´„å‡¦ç† ===== */
function loadReservations(){
  return JSON.parse(localStorage.getItem("bathReservations")) || {};
}
function saveReservations(d){
  localStorage.setItem("bathReservations",JSON.stringify(d));
}

let reservationChart;

function reserve(){
  const t = document.getElementById("reserveTime").value;

  if(!isReservableTime(t)){
    showMessage("ã“ã®æ™‚é–“ã¯äºˆç´„ã§ãã¾ã›ã‚“","error");
    return;
  }

  const r = loadReservations();
  if((r[t]||0) >= maxCapacity){
    showMessage("æº€å“¡ã§ã™","error");
    return;
  }

  r[t]=(r[t]||0)+1;
  saveReservations(r);
  showMessage(`${t} ã«äºˆç´„ã—ã¾ã—ãŸ`);
  drawReservationChart();
}

function resetReservations(){
  const t = document.getElementById("reserveTime").value;
  const r = loadReservations();
  if(!r[t]){
    showMessage("äºˆç´„ãŒã‚ã‚Šã¾ã›ã‚“","error");
    return;
  }
  r[t]--;
  if(r[t]<=0) delete r[t];
  saveReservations(r);
  showMessage("1äººå‰Šé™¤ã—ã¾ã—ãŸ");
  drawReservationChart();
}

function drawReservationChart(){
  const data = reserveLabels.map(t=>loadReservations()[t]||0);
  if(reservationChart) reservationChart.destroy();
  reservationChart = new Chart(document.getElementById("reservationChart"),{
    type:"bar",
    data:{labels:reserveLabels,datasets:[{data}]},
    options:{scales:{y:{min:0,max:maxCapacity}}}
  });
}

/* ===== ãƒœã‚¿ãƒ³åˆ¶å¾¡ ===== */
function updateReserveButton(){
  const n = new Date();
  const m = n.getHours()*60+n.getMinutes();
  const b = document.getElementById("reserveBtn");
  b.disabled = (m < start || m > end);
  b.style.opacity = b.disabled ? 0.5 : 1;
}

/* ===== åˆæœŸåŒ– ===== */
updateTime();
predictCrowd();
drawReservationChart();
updateReserveButton();

setInterval(()=>{
  updateTime();
  predictCrowd();
  updateReserveButton();
},10000);
</script>
</body>
</html>
