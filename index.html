<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãŠé¢¨å‘‚ äºˆç´„å…±æœ‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#f2f6f8;
  margin:0;
  padding:12px;
}
.container{
  max-width:420px;
  margin:auto;
  background:#fff;
  border-radius:16px;
  padding:16px;
}
h1{text-align:center;font-size:1.3rem;}
.time{text-align:center;color:#555;margin-bottom:8px;}
.status{
  text-align:center;
  padding:18px;
  border-radius:12px;
  font-size:1.2rem;
  font-weight:bold;
  margin-bottom:14px;
}
.empty{background:#d4f8d4;color:#2e7d32;}
.crowded{background:#f8d7da;color:#721c24;}

input[type="time"]{
  width:100%;
  font-size:1.1rem;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
  text-align:center;
  margin-bottom:8px;
}

button{
  width:100%;
  height:52px;
  font-size:1.1rem;
  border-radius:12px;
  border:none;
  color:#fff;
  margin-top:8px;
}
.reserveBtn{background:#2196f3;}
.resetBtn{background:#f44336;}
button:disabled{opacity:.4;}

#reserveResult{
  margin-top:10px;
  padding:10px;
  border-radius:8px;
  font-weight:bold;
  text-align:center;
}
.msg-success{background:#d4f8d4;color:#2e7d32;}
.msg-error{background:#f8d7da;color:#721c24;}

.chart-scroll{overflow-x:auto;}
.chart-scroll canvas{
  min-width:360px;
  height:260px !important;
}
</style>
</head>

<body>
<div class="container">
<h1>ğŸ› ãŠé¢¨å‘‚ äºˆç´„ï¼ˆå…±æœ‰ï¼‰</h1>

<div class="time" id="currentTime"></div>
<div class="status" id="statusBox">åˆ¤å®šä¸­â€¦</div>

<input type="time" id="reserveTime" list="timeList">
<datalist id="timeList"></datalist>

<button class="reserveBtn" onclick="reserve()">äºˆç´„ã™ã‚‹</button>
<button class="resetBtn" onclick="removeReservation()">1äººå‰Šé™¤</button>

<div id="reserveResult"></div>

<h2 style="margin-top:16px;">äºˆç´„çŠ¶æ³</h2>
<div class="chart-scroll">
  <canvas id="reservationChart"></canvas>
</div>
</div>

<script>
/* ===== è¨­å®š ===== */
const API_URL = "https://script.google.com/macros/s/AKfycby-TKny5OUsoXfciBqV3OkYfwxq3ZEZPvSiKvMmJozzhaZ3939ckNGvkoSion5iJU2y2A/exec"; 
const maxCapacity = 10;
const start = 15*60+30;
const end   = 20*60+20;

/* ===== æ™‚åˆ»ãƒ©ãƒ™ãƒ« ===== */
const timeLabels=[];
for(let m=start;m<=end;m+=10){
  timeLabels.push(
    String(Math.floor(m/60)).padStart(2,"0")+":"+
    String(m%60).padStart(2,"0")
  );
}

/* ===== datalist ===== */
const dl=document.getElementById("timeList");
timeLabels.forEach(t=>{
  const o=document.createElement("option");
  o.value=t;
  dl.appendChild(o);
});

/* ===== ç¾åœ¨æ™‚åˆ» ===== */
function updateTime(){
  const n=new Date();
  document.getElementById("currentTime").textContent =
    `ç¾åœ¨æ™‚åˆ»ï¼š${String(n.getHours()).padStart(2,"0")}:${String(n.getMinutes()).padStart(2,"0")}`;
}

/* ===== åˆ©ç”¨æ™‚é–“åˆ¤å®š ===== */
function predictStatus(){
  const n=new Date();
  const m=n.getHours()*60+n.getMinutes();
  const s=document.getElementById("statusBox");
  s.className="status";
  if(m<start || m>end){
    s.textContent="ğŸš« åˆ©ç”¨æ™‚é–“å¤–";
    s.classList.add("crowded");
  }else{
    s.textContent="ğŸŸ¢ åˆ©ç”¨å¯èƒ½";
    s.classList.add("empty");
  }
}

/* ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===== */
function showMessage(msg,type="success"){
  const e=document.getElementById("reserveResult");
  e.textContent=msg;
  e.className=type==="success"?"msg-success":"msg-error";
}

/* ===== ãƒ‡ãƒ¼ã‚¿å–å¾— ===== */
async function loadReservations(){
  const res = await fetch(API_URL);
  return await res.json();
}

/* ===== æ›´æ–° ===== */
async function updateReservation(time,delta){
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({time,delta})
  });
}

/* ===== äºˆç´„ ===== */
async function reserve(){
  const t=document.getElementById("reserveTime").value;
  if(!t){
    showMessage("æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„","error");
    return;
  }
  const r=await loadReservations();
  if((r[t]||0)>=maxCapacity){
    showMessage("æº€å“¡ã§ã™","error");
    return;
  }
  await updateReservation(t,+1);
  showMessage(`${t} ã«äºˆç´„ã—ã¾ã—ãŸ`);
  drawReservationChart();
}

async function removeReservation(){
  const t=document.getElementById("reserveTime").value;
  if(!t){
    showMessage("æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„","error");
    return;
  }
  await updateReservation(t,-1);
  showMessage("1äººå‰Šé™¤ã—ã¾ã—ãŸ");
  drawReservationChart();
}

/* ===== ã‚°ãƒ©ãƒ• ===== */
let reservationChart;
async function drawReservationChart(){
  const r=await loadReservations();
  const data=timeLabels.map(t=>r[t]||0);

  if(reservationChart) reservationChart.destroy();
  reservationChart=new Chart(reservationChartCanvas,{
    type:"bar",
    data:{
      labels:timeLabels,
      datasets:[{
        data,
        backgroundColor:data.map(v=>v>=maxCapacity?"#f44336":"#ff9800")
      }]
    },
    options:{
      indexAxis:"y",
      responsive:true,
      maintainAspectRatio:false,
      scales:{x:{min:0,max:maxCapacity}},
      plugins:{legend:{display:false}}
    }
  });
}
const reservationChartCanvas=document.getElementById("reservationChart");

/* ===== åˆæœŸåŒ– ===== */
updateTime();
predictStatus();
drawReservationChart();
setInterval(()=>{
  updateTime();
  predictStatus();
  drawReservationChart();
},5000);
</script>
</body>
</html>

