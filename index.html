<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãŠé¢¨å‘‚ æ··é›‘äºˆæ¸¬ï¼†äºˆç´„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: sans-serif;
      background: #f2f6f8;
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 420px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    h1 {
      text-align: center;
      font-size: 1.4rem;
      margin-bottom: 10px;
    }

    .time {
      text-align: center;
      color: #555;
      margin-bottom: 15px;
    }

    .status {
      text-align: center;
      padding: 18px;
      border-radius: 10px;
      font-size: 1.2rem;
      font-weight: bold;
      margin-bottom: 15px;
    }

    .empty {
      background: #d4f8d4;
      color: #2e7d32;
    }

    .crowded {
      background: #f8d7da;
      color: #721c24;
    }

    canvas {
      margin-top: 15px;
    }

    /* äºˆç´„ */
    .reservation {
      margin-top: 25px;
      padding-top: 15px;
      border-top: 1px solid #ddd;
    }

    .reservation button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      color: #fff;
      font-size: 1rem;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .reserveBtn { background: #2196f3; }
    .reserveBtn:hover { background: #1976d2; }

    .resetBtn { background: #f44336; }
    .resetBtn:hover { background: #d32f2f; }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º */
    #reserveResult {
      margin-top: 10px;
      padding: 10px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
      transition: opacity 0.5s;
    }

    .msg-success {
      background: #d4f8d4;
      color: #2e7d32;
    }

    .msg-error {
      background: #f8d7da;
      color: #721c24;
    }
  </style>
</head>

<body>
<div class="container">
  <h1>ğŸ› ãŠé¢¨å‘‚ æ··é›‘äºˆæ¸¬ï¼†äºˆç´„</h1>

  <div class="time" id="currentTime"></div>
  <div class="status" id="statusBox">äºˆæ¸¬ä¸­â€¦</div>

  <canvas id="crowdChart"></canvas>

  <div class="reservation">
    <h2>åˆ©ç”¨äºˆç´„</h2>
    <input type="time" id="reserveTime" min="15:30" max="22:20">
    <button class="reserveBtn" onclick="reserve()">äºˆç´„ã™ã‚‹</button>
    <button class="resetBtn" onclick="resetReservations()">äºˆç´„ã‚’1äººå‰Šé™¤</button>
    <div id="reserveResult"></div>

    <h2 style="margin-top:20px;">ç¾åœ¨ã®äºˆç´„çŠ¶æ³ï¼ˆäººæ•°ï¼‰</h2>
    <canvas id="reservationChart"></canvas>
  </div>
</div>

<script>
/* ===== è¨­å®š ===== */
const maxCapacity = 5;

const timeLabels = [
  "15:30","15:40","15:50",
  "16:00","16:10","16:20","16:30","16:40","16:50",
  "17:00","17:10","17:20","17:30","17:40","17:50",
  "18:00","18:10","18:20","18:30","18:40","18:50",
  "19:00","19:10","19:20","19:30","19:40","19:50",
  "20:00","20:10","20:20"
];

const reserveLabels = [
  ...timeLabels,
  "20:30","20:40","20:50",
  "21:00","21:10","21:20","21:30","21:40","21:50",
  "22:00","22:10","22:20"
];

// æ™‚åˆ»
function updateTime() {
  const now = new Date();
  const week = ["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"];
  document.getElementById("currentTime").textContent =
    `ç¾åœ¨æ™‚åˆ»ï¼š${now.getHours().toString().padStart(2,"0")}:${now.getMinutes().toString().padStart(2,"0")}ï¼ˆ${week[now.getDay()]}ï¼‰`;
}

//ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
function showMessage(text, type="success"){
  const el = document.getElementById("reserveResult");
  el.textContent = text;
  el.className = type === "success" ? "msg-success" : "msg-error";
  el.style.opacity = "1";
  setTimeout(()=> el.style.opacity="0.3", 3000);
}

// 0:æ—¥ 1:æœˆ 2:ç« 3:æ°´ 4:æœ¨ 5:é‡‘ 6:åœŸ
const crowdDataByDay = {
  0: [ // æ—¥
    40,45,50,55,60,65,70,72,75,
    78,80,82,85,87,88,90,90,92,
    93,94,95,96,97,97,98,98,99,
    99,99,98
  ],
  1: [ // æœˆ
    15,18,20,25,30,35,40,42,45,
    50,55,60,65,65,64,66,68,70,
    72,73,75,78,80,82,83,84,85,
    87,88,85
  ],
  2: [ // ç«
    18,20,22,28,32,36,42,45,48,
    52,58,62,66,66,65,67,69,71,
    73,75,77,80,82,84,85,86,87,
    89,90,88
  ],
  3: [ // æ°´
    20,22,25,30,35,40,45,48,50,
    55,60,65,70,70,69,71,72,74,
    76,78,80,83,85,87,88,89,90,
    92,93,90
  ],
  4: [ // æœ¨
    22,25,28,32,37,42,47,50,53,
    58,63,68,72,72,71,73,75,77,
    79,81,83,86,88,89,90,91,92,
    94,95,92
  ],
  5: [ // é‡‘
    30,35,40,45,50,55,60,63,65,
    70,75,80,85,85,84,86,87,88,
    89,90,91,92,93,94,95,96,97,
    98,98,97
  ],
  6: [ // åœŸ
    35,40,45,50,55,60,65,68,70,
    75,80,85,90,90,89,91,92,93,
    94,95,96,97,98,98,99,99,99,
    99,99,98
  ]
};
function getTodayCrowdData() {
  const day = new Date().getDay(); // 0ã€œ6
  return crowdDataByDay[day];
}


function predictCrowd() {
  const now = new Date();
  const m = now.getHours() * 60 + now.getMinutes();
  const status = document.getElementById("statusBox");
  status.className = "status";

  if (m < 930 || m > 1340) {
    status.textContent = "ç©ºã„ã¦ã„ã¾ã›ã‚“";
    status.classList.add("crowded");
    return;
  }

  // ç¾åœ¨æ™‚åˆ»ã«å¯¾å¿œã™ã‚‹ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
  const index = Math.floor((m - 930) / 10);
  const todayData = getTodayCrowdData();
  const crowd = todayData[index];

  if (crowd >= 70) {
    status.textContent = "æ··é›‘ã—ã¦ã„ã¾ã™";
    status.classList.add("crowded");
  } else {
    status.textContent = "ç©ºã„ã¦ã„ã¾ã™";
    status.classList.add("empty");
  }
}


//æ··é›‘ã‚°ãƒ©ãƒ•
const todayCrowdData = getTodayCrowdData();

new Chart(document.getElementById("crowdChart"), {
  type: "line",
  data: {
    labels: timeLabels,
    datasets: [{
      data: todayCrowdData,
      label: "æ··é›‘åº¦ï¼ˆï¼…ï¼‰",
      borderColor: "#2196f3",
      backgroundColor: "rgba(33,150,243,0.2)",
      fill: true,
      tension: 0.3,
      pointRadius: 2
    }]
  },
  options: {
    scales: { y: { min: 0, max: 100 } }
  }
});


// äºˆç´„ 
function loadReservations(){
  return JSON.parse(localStorage.getItem("bathReservations")) || {};
}
function saveReservations(d){
  localStorage.setItem("bathReservations", JSON.stringify(d));
}

let reservationChart;

function reserve(){
  const t = document.getElementById("reserveTime").value;
  if(!t){ showMessage("æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„","error"); return; }

  const r = loadReservations();
  if((r[t]||0) >= maxCapacity){
    showMessage(`${t} ã¯æº€å“¡ã§ã™`,`error`);
    return;
  }
  r[t]=(r[t]||0)+1;
  saveReservations(r);
  showMessage(`${t} ã«äºˆç´„ã—ã¾ã—ãŸï¼ˆ${r[t]}äººç›®ï¼‰`);
  drawReservationChart();
}

function resetReservations(){
  const t = document.getElementById("reserveTime").value;
  if(!t){ showMessage("æ™‚åˆ»ã‚’é¸æŠã—ã¦ãã ã•ã„","error"); return; }

  const r = loadReservations();
  if(!r[t]){
    showMessage("ãã®æ™‚é–“ã«äºˆç´„ã¯ã‚ã‚Šã¾ã›ã‚“","error");
    return;
  }
  r[t]--;
  if(r[t]<=0) delete r[t];
  saveReservations(r);
  showMessage(`${t} ã®äºˆç´„ã‚’1äººå‰Šé™¤ã—ã¾ã—ãŸ`);
  drawReservationChart();
}

function drawReservationChart(){
  const data = reserveLabels.map(l=>loadReservations()[l]||0);
  if(reservationChart) reservationChart.destroy();
  reservationChart = new Chart(document.getElementById("reservationChart"),{
    type:"bar",
    data:{labels:reserveLabels,datasets:[{
      data,
      backgroundColor:data.map(v=>v===maxCapacity?"#f44336":"#ff7043")
    }]},
    options:{scales:{y:{min:0,max:maxCapacity,stepSize:1}},plugins:{legend:{display:false}}}
  });
}
function getTodayKey(){
  const d = new Date();
  return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
}
function resetAllReservations(){
  localStorage.removeItem("bathReservations");
  drawReservationChart();
  showMessage("æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸãŸã‚äºˆç´„ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ");
}
function checkDateChange(){
  const today = getTodayKey();
  const lastDate = localStorage.getItem("lastResetDate");

  if(lastDate !== today){
    localStorage.setItem("lastResetDate", today);
    resetAllReservations();
  }
}

//åˆæœŸåŒ– 
updateTime();
predictCrowd();
drawReservationChart();
checkDateChange();

// 1åˆ†ã”ã¨ã«æ™‚åˆ»ãƒ»æ··é›‘ãƒ»æ—¥ä»˜å¤‰æ›´ã‚’ãƒã‚§ãƒƒã‚¯
setInterval(()=>{
  updateTime();
  predictCrowd();
  checkDateChange();
}, 10000);
</script>
</body>
</html>
