<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ãŠé¢¨å‘‚ äºˆç´„å…±æœ‰ï¼ˆGoogle Sheetsï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
  background:#f2f6f8;
  margin:0;
  padding:12px;
}
.container{
  max-width:420px;
  margin:auto;
  background:#fff;
  border-radius:16px;
  padding:16px;
}
h1{text-align:center;font-size:1.3rem;}
input[type="time"]{
  width:100%;
  font-size:1.1rem;
  padding:12px;
  border-radius:10px;
  border:1px solid #ccc;
}
button{
  width:100%;
  height:52px;
  font-size:1.1rem;
  border-radius:12px;
  border:none;
  color:#fff;
  margin-top:8px;
}
.reserveBtn{background:#2196f3;}
.resetBtn{background:#f44336;}

#msg{
  margin-top:10px;
  padding:10px;
  border-radius:8px;
  text-align:center;
  font-weight:bold;
}

.chart-scroll{overflow-x:auto;}
canvas{height:260px!important;}
</style>
</head>

<body>
<div class="container">
<h1>ğŸ› ãŠé¢¨å‘‚ äºˆç´„å…±æœ‰</h1>

<input type="time" id="reserveTime">
<button class="reserveBtn" onclick="reserve(1)">äºˆç´„ã™ã‚‹</button>
<button class="resetBtn" onclick="reserve(-1)">1äººå‰Šé™¤</button>

<div id="msg"></div>

<h2>äºˆç´„çŠ¶æ³</h2>
<div class="chart-scroll">
  <canvas id="chart"></canvas>
</div>
</div>

<script>
/* ===== è¨­å®š ===== */
const API_URL = "â˜…ã“ã“ã«Apps Scriptã®URLâ˜…";
const maxCapacity = 10;
const start = 15*60+30;
const end   = 20*60+20;

/* ===== æ™‚åˆ»ãƒ©ãƒ™ãƒ« ===== */
const timeLabels=[];
for(let m=start;m<=end;m+=10){
  timeLabels.push(
    String(Math.floor(m/60)).padStart(2,"0")+":"+String(m%60).padStart(2,"0")
  );
}

/* ===== ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ ===== */
function show(msg){
  const e=document.getElementById("msg");
  e.textContent=msg;
}

/* ===== ãƒ‡ãƒ¼ã‚¿å–å¾— ===== */
async function loadReservations(){
  const r = await fetch(API_URL);
  return await r.json();
}

/* ===== æ›´æ–° ===== */
async function updateReservation(time, delta){
  await fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({time, delta})
  });
}

/* ===== äºˆç´„å‡¦ç† ===== */
async function reserve(delta){
  const t=document.getElementById("reserveTime").value;
  if(!t){ show("æ™‚åˆ»ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

  const [h,m]=t.split(":").map(Number);
  const min=h*60+m;
  const now=new Date();
  const nowMin=now.getHours()*60+now.getMinutes();

  if(min<start||min>end||min<nowMin){
    show("ã“ã®æ™‚é–“ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“");
    return;
  }

  await updateReservation(t, delta);
  show(delta>0?"äºˆç´„ã—ã¾ã—ãŸ":"å‰Šé™¤ã—ã¾ã—ãŸ");
  drawChart();
}

/* ===== ã‚°ãƒ©ãƒ• ===== */
let chart;
async function drawChart(){
  const res = await loadReservations();
  const data = timeLabels.map(t=>res[t]||0);

  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("chart"),{
    type:"bar",
    data:{
      labels:timeLabels,
      datasets:[{
        data,
        backgroundColor:data.map(v=>v>=maxCapacity?"#f44336":"#ff9800")
      }]
    },
    options:{
      indexAxis:"y",
      scales:{x:{min:0,max:maxCapacity}},
      plugins:{legend:{display:false}}
    }
  });
}

/* ===== è‡ªå‹•æ›´æ–° ===== */
drawChart();
setInterval(drawChart,5000);
</script>
</body>
</html>
